{% extends "layouts/module_admin.html" %}

{% block module %}
  <!-- Vue 2 -->
  <script src="{{ config.ASSETS_ROOT }}/plugins/vue/vue@2.js"></script>
  
  <!-- Highcharts -->
  <script src="/HistoryView/static/highcharts/highstock.js"></script>
  <script src="/HistoryView/static/highcharts/highstock-3d.js"></script>
  <script src="/HistoryView/static/highcharts/exporting.js"></script>
  <script src="/HistoryView/static/highcharts/export-data.js"></script>
  <script src="/HistoryView/static/highcharts/accessibility.js"></script>
  
  <div id="history_app">
    <h3>{{ _('History')}} <a :href="'Objects?view=object&object='+info.object_id+'&tab=properties'">[[object_name]].[[property_name]]</a></h3>
    <small>{{ _('Description')}}: [[info.object_description ?? "{{ _('No description')}}"]].[[info.description ?? "{{ _('No description')}}"]]</small>
    <div class="my-2">
      {{ _('Periods')}}: <div class="btn mx-1" :class="period == item.value ? 'btn-primary':'btn-secondary'" v-for="item in periods" @click="period = item.value">[[item.title]]</div>
      <span v-if="!loading">{{ _('Count values')}}: [[chartData.length]]</span>
      <i v-else class="fa-solid fa-spinner fa-spin"></i>
    </div>
    <!-- Вкладки -->
    <ul class="nav nav-tabs" role="tablist">
      <li v-if="viewCharts" class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#charts">{{ _('Graph')}}</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" :class="{ active : !viewCharts}" data-bs-toggle="tab" href="#table">{{ _('Table')}}</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#info">{{ _('Info')}}</a>
      </li>
    </ul>
    <!-- Содержимое вкладок -->
    <div class="tab-content">
      <!-- Вкладка "Графики" -->
      <div v-if="viewCharts" class="tab-pane active" id="charts" role="tabpanel">
        <div class="input-group my-3">
          <label class="input-group-text" or="inputGroupSelect01">{{ _('Preset')}}</label>
          <select class="form-select" id="inputGroupSelect01" v-model="chartType" @change="updateChart">
            <option v-for="item in chartTypes" :value="item.value">[[item.title]]</option>
          </select>
        </div>
       <div id="lineChart" style="min-width: 310px; height: 500px; margin: 0 auto;"></div>
       <div id="pieChart" style="min-width: 310px; height: 400px; margin: 0 auto;"></div>
      </div>

      <!-- Вкладка "Таблица" -->
      <div class="tab-pane fad" :class="{ active : !viewCharts}" id="table" role="tabpanel">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>{{ _('Value')}}</th>
              <th>{{ _('Changed')}}</th>
              <th>{{ _('Source')}}</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(item, index) in paginatedData" :key="item.id">
              <td>[[ item.value ]]</td>
              <td>[[ formatDate(item.added) ]]</td>
              <td>[[ item.source || 'Unknown' ]]</td>
              <td><a :href="'?op=delete&id='+item.id+'&object={{object.id}}&name={{name}}'" onClick="return confirm('Are you sure? Please confirm.')" class="btn btn-sm btn-danger" title="{{ _('Delete')}}"><i class="feather icon-trash"></i></a></td>
            </tr>
          </tbody>
        </table>

        <!-- Пагинация -->
        <nav aria-label="Page navigation" class="mt-4">
          <ul class="pagination justify-content-center">
            <li class="page-item" :class="{ disabled: currentPage === 1 }">
              <a class="page-link" href="#" @click="prevPage">{{ _('Prev')}}</a>
            </li>
            <li v-for="(page,index) in totalPages" :key="page" class="page-item" :class="{ active: page === currentPage }">
              <a class="page-link" href="#" @click="goToPage(page)">[[page]]</a>
            </li>
            <li class="page-item" :class="{ disabled: currentPage === totalPages }">
              <a class="page-link" href="#" @click="nextPage">{{ _('Next')}}</a>
            </li>
          </ul>
        </nav>
      </div>
      <div class="tab-pane p-3" id="info" role="tabpanel">
        {{ _('Name')}}: <b>[[info.name]]</b><br>
        {{ _('Description')}}: <b>[[info.description ?? '-']]</b><br>
        {{ _('Type')}}: <b>[[info.type ?? '-']]</b><br>
        {{ _('History')}}: <b>[[info.history]]</b><br>
        {{ _('Link')}}: <span class="badge bg-success text-light" v-for="item in info.linked">[[item]]</span><br>
       </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#history_app',
      delimiters: ['[[', ']]'], // Измененные разделители
      data() {
        return {
          loading: true,
          info:{},
          object_name: "{{object.name}}",
          property_name: "{{name}}",
          chartData: [],
          values:[],
          sourceCounts: {},
          step: undefined,
          currentPage: 1, // Текущая страница пагинации
          pageSize: 25, // Количество элементов на странице
          period:1,
          periods:[
            {"title":"1 {{ _('hour') }}", "value": 1},
            {"title":"3 {{ _('hours') }}", "value": 3},
            {"title":"6 {{ _('hours') }}", "value": 6},
            {"title":"12 {{ _('hours') }}", "value": 12},
            {"title":"{{ _('Day') }}", "value": 24},
            {"title":"{{ _('Week') }}", "value": 168},
            {"title":"2 {{ _('weeks') }}", "value": 336},
            {"title":"{{ _('Month') }}", "value": 720},
            {"title":"3 {{ _('months') }}", "value": 2160},
            {"title":"6 {{ _('months') }}", "value": 4320},
            {"title":"{{ _('Year') }}", "value": 8640},
            {"title":"{{ _('All') }}", "value": -1},
          ],
          chartType: "line",
          chartTypes: [
            {"title":"{{ _('Line') }}", "value": 'line'},
            {"title":"{{ _('Column') }}", "value": 'column'},
            {"title":"{{ _('Spline') }}", "value": 'spline'},
            {"title":"{{ _('Area') }}", "value": 'area'},
          ]
        };
      },
      computed: {
        // Вычисляемые данные для текущей страницы
        paginatedData() {
          const start = (this.currentPage - 1) * this.pageSize;
          const end = start + this.pageSize;
          return this.chartData.slice(start, end);
        },
        // Общее количество страниц
        totalPages() {
          return Math.ceil(this.chartData.length / this.pageSize);
        },
        viewCharts(){
          return this.info.type=='int' || this.info.type=='float' || this.info.type=='bool'
        }
      },
      watch:{
        period(){
          this.fetchData()
        },
      },
      methods: {
        // Получение цветов из CSS переменных Bootstrap 5
        getBootstrapColors() {
          // Получаем актуальный элемент body с учетом текущей темы
          const body = document.querySelector('[data-tag="body"]') || document.body;
          const currentTheme = body.getAttribute('data-bs-theme');
          const isDark = currentTheme === 'dark';
          
          // Получаем CSS переменные Bootstrap 5 из вычисленных стилей
          const getCSSVariable = (varName) => {
            const value = getComputedStyle(body).getPropertyValue(varName).trim();
            // Если значение пустое, возвращаем null
            return value || null;
          };
          
          // Получаем значения с fallback на значения по умолчанию
          const primary = getCSSVariable('--bs-primary') || (isDark ? '#0d6efd' : '#0d6efd');
          const secondary = getCSSVariable('--bs-secondary') || (isDark ? '#6c757d' : '#6c757d');
          const textColor = getCSSVariable('--bs-body-color') || (isDark ? '#fff' : '#212529');
          const backgroundColor = getCSSVariable('--bs-body-bg') || (isDark ? '#212529' : '#fff');
          const borderColor = getCSSVariable('--bs-border-color') || (isDark ? '#495057' : '#dee2e6');
          
          const colors = {
            // Основные цвета
            primary: primary,
            secondary: secondary,
            success: getCSSVariable('--bs-success') || (isDark ? '#198754' : '#198754'),
            danger: getCSSVariable('--bs-danger') || (isDark ? '#dc3545' : '#dc3545'),
            warning: getCSSVariable('--bs-warning') || (isDark ? '#ffc107' : '#ffc107'),
            info: getCSSVariable('--bs-info') || (isDark ? '#0dcaf0' : '#0dcaf0'),
            
            // Цвета текста и фона
            textColor: textColor,
            backgroundColor: backgroundColor,
            
            // Цвета границ
            borderColor: borderColor,
            
            // Дополнительные цвета для графиков
            gridLineColor: borderColor,
            minorGridLineColor: getCSSVariable('--bs-border-color') || (isDark ? '#343a40' : '#e9ecef'),
            
            // Цвета для rangeSelector и navigator
            rangeSelectorButton: isDark ? '#495057' : '#f8f9fa',
            rangeSelectorButtonHover: isDark ? '#6c757d' : '#e9ecef',
            rangeSelectorButtonActive: primary,
          };
          
          console.log('Bootstrap colors retrieved for theme:', currentTheme, colors);
          return colors;
        },
        // Применение темы Bootstrap 5 к Highcharts
        applyBootstrapTheme() {
          const colors = this.getBootstrapColors();
          console.log('Applying Bootstrap theme, colors:', colors);
          
          Highcharts.setOptions({
            time: {
              timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            },
            colors: [
              colors.primary,
              colors.success,
              colors.info,
              colors.warning,
              colors.danger,
              colors.secondary,
              '#fd7e14',
              '#20c997',
              '#6f42c1',
              '#d63384'
            ],
            chart: {
              backgroundColor: colors.backgroundColor,
              borderColor: colors.borderColor,
              style: {
                color: colors.textColor,
                fontFamily: 'var(--bs-font-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif)'
              }
            },
            title: {
              style: {
                color: colors.textColor
              }
            },
            subtitle: {
              style: {
                color: colors.textColor
              }
            },
            xAxis: {
              gridLineColor: colors.gridLineColor,
              lineColor: colors.borderColor,
              minorGridLineColor: colors.minorGridLineColor,
              tickColor: colors.borderColor,
              title: {
                style: {
                  color: colors.textColor
                }
              },
              labels: {
                style: {
                  color: colors.textColor
                }
              }
            },
            yAxis: {
              gridLineColor: colors.gridLineColor,
              lineColor: colors.borderColor,
              minorGridLineColor: colors.minorGridLineColor,
              tickColor: colors.borderColor,
              title: {
                style: {
                  color: colors.textColor
                }
              },
              labels: {
                style: {
                  color: colors.textColor
                }
              }
            },
            legend: {
              backgroundColor: colors.backgroundColor,
              itemStyle: {
                color: colors.textColor
              },
              itemHoverStyle: {
                color: colors.primary
              },
              itemHiddenStyle: {
                color: colors.secondary
              }
            },
            credits: {
              style: {
                color: colors.secondary
              }
            },
            labels: {
              style: {
                color: colors.textColor
              }
            },
            tooltip: {
              backgroundColor: colors.backgroundColor,
              borderColor: colors.borderColor,
              style: {
                color: colors.textColor
              }
            },
            plotOptions: {
              series: {
                borderColor: colors.borderColor
              },
              boxplot: {
                fillColor: colors.backgroundColor
              },
              candlestick: {
                lineColor: colors.textColor
              },
              errorbar: {
                color: colors.textColor
              }
            },
            rangeSelector: {
              buttonTheme: {
                fill: colors.rangeSelectorButton,
                stroke: colors.borderColor,
                style: {
                  color: colors.textColor
                },
                states: {
                  hover: {
                    fill: colors.rangeSelectorButtonHover,
                    stroke: colors.borderColor,
                    style: {
                      color: colors.textColor
                    }
                  },
                  select: {
                    fill: colors.rangeSelectorButtonActive,
                    stroke: colors.borderColor,
                    style: {
                      color: '#fff'
                    }
                  }
                }
              },
              inputBoxBorderColor: colors.borderColor,
              inputStyle: {
                backgroundColor: colors.backgroundColor,
                color: colors.textColor
              },
              labelStyle: {
                color: colors.textColor
              }
            },
            navigator: {
              handles: {
                backgroundColor: colors.backgroundColor,
                borderColor: colors.borderColor
              },
              outlineColor: colors.borderColor,
              maskFill: 'rgba(0, 0, 0, 0.1)',
              series: {
                color: colors.primary,
                lineColor: colors.primary
              },
              xAxis: {
                gridLineColor: colors.gridLineColor
              }
            },
            scrollbar: {
              barBackgroundColor: colors.rangeSelectorButton,
              barBorderColor: colors.borderColor,
              buttonArrowColor: colors.textColor,
              buttonBackgroundColor: colors.backgroundColor,
              buttonBorderColor: colors.borderColor,
              rifleColor: colors.textColor,
              trackBackgroundColor: colors.backgroundColor,
              trackBorderColor: colors.borderColor
            }
          });
        },
        // Обновление графиков при смене темы
        updateChartsTheme() {
          console.log('Updating charts theme...');
          
          // ВСЕГДА применяем тему Bootstrap 5 (обновляем глобальные настройки Highcharts)
          // Это должно быть сделано независимо от наличия данных
          this.applyBootstrapTheme();
          
          // Задержка, чтобы CSS переменные точно обновились
          setTimeout(() => {
            // Находим существующие графики
            const existingLineChart = Highcharts.charts.find(chart => 
              chart && chart.renderTo && chart.renderTo.id === 'lineChart'
            );
            const existingPieChart = Highcharts.charts.find(chart => 
              chart && chart.renderTo && chart.renderTo.id === 'pieChart'
            );
            
            // Если есть данные - пересоздаем графики с новой темой
            if (this.values && this.values.length > 0) {
              // Уничтожаем и пересоздаем линейный график
              if (existingLineChart) {
                console.log('Destroying existing line chart to recreate with new theme');
                existingLineChart.destroy();
              }
              
              // Небольшая пауза перед пересозданием
              setTimeout(() => {
                console.log('Recreating line chart with new theme');
                this.updateChart();
              }, 50);
            } else if (existingLineChart) {
              // Если данных нет, но график существует - обновляем его тему через update()
              console.log('No data available, updating existing chart theme');
              try {
                const colors = this.getBootstrapColors();
                existingLineChart.update({
                  chart: {
                    backgroundColor: colors.backgroundColor,
                    style: {
                      color: colors.textColor
                    }
                  },
                  title: {
                    style: {
                      color: colors.textColor
                    }
                  },
                  xAxis: {
                    gridLineColor: colors.gridLineColor,
                    lineColor: colors.borderColor,
                    tickColor: colors.borderColor,
                    labels: {
                      style: {
                        color: colors.textColor
                      }
                    }
                  },
                  yAxis: {
                    gridLineColor: colors.gridLineColor,
                    lineColor: colors.borderColor,
                    tickColor: colors.borderColor,
                    labels: {
                      style: {
                        color: colors.textColor
                      }
                    }
                  }
                }, true); // true = redraw
              } catch (e) {
                console.error('Error updating chart theme:', e);
              }
            }
            
            // Обновляем круговую диаграмму, если есть данные
            if (this.sourceCounts && Object.keys(this.sourceCounts).length > 0) {
              // Уничтожаем и пересоздаем круговую диаграмму
              if (existingPieChart) {
                console.log('Destroying existing pie chart to recreate with new theme');
                existingPieChart.destroy();
              }
              
              setTimeout(() => {
                const pieData = Object.keys(this.sourceCounts).map(source => ({
                  name: source,
                  y: this.sourceCounts[source]
                }));
                
                console.log('Recreating pie chart with new theme');
                Highcharts.chart('pieChart', {
                  chart: { 
                    type: 'pie',
                    options3d: {
                      enabled: true,
                      alpha: 45,
                      beta: 0
                    },
                  },
                  plotOptions: {
                      pie: {
                          allowPointSelect: true,
                          cursor: 'pointer',
                          depth: 35,
                          dataLabels: {
                              enabled: true,
                              format: '{point.name}'
                          }
                      }
                  },
                  title: { text: "{{ _('Distribution by sources')}}" },
                  series: [{
                    name: "{{ _('Sources')}}",
                    data: pieData
                  }]
                });
              }, 50);
            } else if (existingPieChart) {
              // Если данных нет, но график существует - обновляем его тему
              console.log('No pie data available, updating existing pie chart theme');
              try {
                const colors = this.getBootstrapColors();
                existingPieChart.update({
                  chart: {
                    backgroundColor: colors.backgroundColor,
                    style: {
                      color: colors.textColor
                    }
                  },
                  title: {
                    style: {
                      color: colors.textColor
                    }
                  }
                }, true); // true = redraw
              } catch (e) {
                console.error('Error updating pie chart theme:', e);
              }
            }
          }, 150);
        },
        // Формирование временного диапазона для последнего часа
        getDateTimeRange() {
          const now = new Date();
          console.log(now)
          var hoursAgo = new Date("2000-01-01")
          if (this.period > 0) 
            hoursAgo = new Date(now.getTime() - this.period * 60 * 60 * 1000); // Вычитаем период в часах

          const dtBegin = new Date(hoursAgo.getTime() - (hoursAgo.getTimezoneOffset() * 60000)).toISOString().split('.')[0]; // Убираем миллисекунды
          const dtEnd = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('.')[0]; // Убираем миллисекунды

          return { dtBegin, dtEnd };
        },
        // Сортировка данных по дате в обратном порядке
        sortDataByDateDescending(data) {
          return data.sort((a, b) => {
            const dateA = new Date(a.added);
            const dateB = new Date(b.added);
            return dateB - dateA; // От поздней к ранней
          });
        },
        fetchInfo(){
          fetch("/api/property/info/"+this.object_name+"."+this.property_name)
          .then(response => response.json())
          .then(data => {
            console.log(data)
            if (data.success) {
              this.info = data.result
              if (this.info.type == 'int')
                this.step = 'left'
              this.fetchData()
            }
          })
          .catch(error => {
            console.error('Ошибка при запросе к API:', error);
          });
        },
        // Загрузка данных через API
        fetchData() {
          this.loading = true
          const { dtBegin, dtEnd } = this.getDateTimeRange();
          console.log(dtBegin, dtEnd)

          fetch(`/api/property/history?object=${this.object_name}&property=${this.property_name}&dt_begin=${dtBegin}&dt_end=${dtEnd}`)
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // ВСЕГДА применяем тему Bootstrap 5 перед обработкой данных
              // Это гарантирует, что тема будет применена даже если данных нет или они пустые
              this.applyBootstrapTheme();
              
              this.chartData = this.sortDataByDateDescending(data.result);

              if (!this.viewCharts){
                this.loading = false
                return
              }
              
              // Подготовка данных для линейного графика
              this.values = data.result.map(item => {
                // Преобразуем строку даты в объект Date и затем в Unix timestamp (миллисекунды)
                const timestamp = new Date(item.added.replace(' ', 'T')).getTime();
                return [timestamp, item.value];
              });

              // Небольшая задержка, чтобы тема точно применилась
              setTimeout(() => {
                this.updateChart();
              }, 50);

              
              // Подготовка данных для круговой диаграммы
              this.sourceCounts = data.result.reduce((acc, item) => {
                const source = item.source || 'Unknown';
                acc[source] = (acc[source] || 0) + 1;
                return acc;
              }, {});

              const pieData = Object.keys(this.sourceCounts).map(source => ({
                name: source,
                y: this.sourceCounts[source]
              }));

              // Инициализация круговой диаграммы
              Highcharts.chart('pieChart', {
                chart: { 
                  type: 'pie',
                  options3d: {
                    enabled: true,
                    alpha: 45,
                    beta: 0
                  },
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        depth: 35,
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}'
                        }
                    }
                },
                title: { text: "{{ _('Distribution by sources')}}" },
                series: [{
                  name: "{{ _('Sources')}}",
                  data: pieData
                }]

              });
            } else {
              console.error('Ошибка при загрузке данных');
            }
            this.loading = false
          })
          .catch(error => {
            this.loading = false
            console.error('Ошибка при запросе к API:', error);
          });
        },
         updateChart(){
           // Уничтожаем существующий график, если он есть
           const existingChart = Highcharts.charts.find(chart => 
             chart && chart.renderTo && chart.renderTo.id === 'lineChart'
           );
           if (existingChart) {
             existingChart.destroy();
           }
           
           if (this.chartType=='line')
             this.linePreset()
           else if (this.chartType=='column')
             this.linePreset()
           else if (this.chartType=='spline')
             this.linePreset()
           else if (this.chartType=='area')
             this.linePreset()
         },
        linePreset(){
          // Create a timer
          const start = +new Date();
          // Инициализация линейного графика
          Highcharts.chart('lineChart', {
                chart: {
                  events: {
                      load: function () {
                          if (!window.TestController) {
                              this.setTitle(null, {
                                  text:
                                      "{{ _('Built chart in')}} " + (new Date() - start) + "ms"
                              });
                          }
                      },
                      // Добавляем событие после завершения зума для показа кнопки "Сброс Zoom"
                      afterSetExtremes: function () {
                        const chart = this.chart;
                        if (!chart.resetZoomButton) {
                          chart.showResetZoom(); // Показываем кнопку "Сброс Zoom"
                        }
                      }
                  },
                  type: this.chartType,
                  zooming: {
                    type: 'x'
                  },
                  resetZoomButton: true,
                },
                rangeSelector: {
                  enabled: true, // Включаем RangeSelector
                  buttons: [
                    { type: 'day', count: 1, text: '1D' }, // Выбор последних 1 дня
                    { type: 'week', count: 1, text: '1W' }, // Выбор последней недели
                    { type: 'month', count: 1, text: '1M' }, // Выбор последнего месяца
                    { type: 'year', count: 1, text: '1Y' }, // Выбор последнего года
                    { type: 'all', text: 'All' } // Выбор всего диапазона
                  ],
                  selected: 4, // По умолчанию выбран "All"
                  inputEnabled: false
                },
                navigator: {
                  enabled: true, // Включаем Navigator (превью графика)
                  series: {
                    color: this.getBootstrapColors().primary, // Цвет превью из Bootstrap 5
                    lineColor: this.getBootstrapColors().primary // Цвет линии превью из Bootstrap 5
                  }
                },
                title: { text: "{{ _('History')}}"},
                xAxis: {
                  type: 'datetime',
                  crosshair: true // Показывать перекрестие при наведении
                },
                yAxis: { title: { text: "{{ _('Value')}}" } },
                series: [{
                  name: this.property_name+"("+this.info.description+")",
                  step: this.step,
                  turboThreshold: 0, // Отключаем оптимизацию для точек
                  data: this.values.sort(function(x, y) {
                    if (x[0] === y[0]) {
                      return 0;
                    } else {
                      return x[0] < y[0] ? -1 : 1
                    }
                  }),
                  //color: '#FF3333',
                  //negativeColor: '#48AFE8',
                }]
              });

        },
        // Форматирование даты
        formatDate(dateString) {
          const date = new Date(dateString);
          return date.toLocaleString('ru-RU', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'});
        },
        // Переключение на предыдущую страницу
        prevPage() {
          if (this.currentPage > 1) {
            this.currentPage--;
          }
        },
        // Переключение на следующую страницу
        nextPage() {
          if (this.currentPage < this.totalPages) {
            this.currentPage++;
          }
        },
        // Переключение на указанную страницу
        goToPage(page) {
          if (page >= 1 && page <= this.totalPages) {
            this.currentPage = page;
          }
        }
      },
      mounted() {
        // Применяем тему Bootstrap 5 при инициализации
        this.applyBootstrapTheme();
        
        // Отслеживаем изменения темы Bootstrap 5
        const body = document.querySelector('[data-tag="body"]') || document.body;
        const self = this;
        
        // MutationObserver для отслеживания изменений атрибута data-bs-theme
        const themeObserver = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
              // Тема изменилась, обновляем графики
              console.log('Theme changed to:', body.getAttribute('data-bs-theme'));
              self.updateChartsTheme();
            }
          });
        });
        
        // Начинаем наблюдение за изменениями атрибута data-bs-theme
        themeObserver.observe(body, {
          attributes: true,
          attributeFilter: ['data-bs-theme']
        });
        
        // Также слушаем клики на переключатель темы (на случай, если MutationObserver не сработает)
        const themeToggle = document.querySelector('.theme-toggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            // Небольшая задержка, чтобы дать время Bootstrap обновить атрибут и CSS переменные
            setTimeout(() => {
              console.log('Theme toggle clicked, current theme:', body.getAttribute('data-bs-theme'));
              self.updateChartsTheme();
            }, 200);
          });
        }
        
        // Сохраняем начальную тему для отслеживания изменений
        self._lastTheme = body.getAttribute('data-bs-theme');
        
        // Дополнительная проверка изменений темы (на случай, если MutationObserver пропустит)
        const checkThemeChange = () => {
          const currentTheme = body.getAttribute('data-bs-theme');
          if (self._lastTheme !== currentTheme) {
            console.log('Theme changed from', self._lastTheme, 'to', currentTheme);
            self._lastTheme = currentTheme;
            self.updateChartsTheme();
          }
        };
        
        // Периодически проверяем изменения темы (каждые 300мс)
        setInterval(checkThemeChange, 300);
        
        this.fetchInfo()
      }
    });
  </script>
{% endblock %}